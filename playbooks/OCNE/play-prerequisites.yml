#
# Oracle Linux Automation Manager
#
# Copyright (c) 2022 Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at
# https://oss.oracle.com/licenses/upl.
#
# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
#
# Description: Ansible playbook to setup package repositories
# for OCNE and install packages.
#
# yamllint disable
#  hosts: ocne_op ocne_kube_control ocne_kube_worker

---

- name: Set pre-requisites aka public keys and dnf repositories
  hosts: "{{hostlist}}"
  become: yes
  become_method: sudo
  gather_facts: false

  tasks:
  - name: Copy Public Key
    copy:
      src: "{{ playbook_dir }}/files/id_rsa.pub"
      dest: "/root/.ssh/authorized_keys"
      owner: root
      mode: 0600

  - name: Add proxy config to dnf.conf
    lineinfile:
      path: /etc/dnf/dnf.conf
      line: "proxy={{ my_https_proxy }}"
      state: present
    when:
    - use_proxy == true

  - name: Install oracle-olcne-release-el8 RPM
    dnf:
      name: oracle-olcne-release-el8
      state: latest
    ignore_errors: yes

  - name: Enable the OL8 repos
    shell: |
           dnf config-manager --enable {{ ocne_repo }} ol8_addons ol8_UEKR6 ol8_baseos_latest

  - name: Disable OL8 older olcne repos
    shell: |
           dnf config-manager --disable ol8_olcne14 ol8_olcne13 ol8_olcne12
    when:
      - ocne_repo == "ol8_olcne15"
    ignore_errors: yes

  - name: Disable OL8 development repos
    shell: |
           dnf config-manager --disable ol8_developer ol8_developer_EPEL
    ignore_errors: yes

